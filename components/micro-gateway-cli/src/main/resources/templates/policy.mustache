import ballerina/io;
import ballerina/runtime;
import ballerina/http;
import ballerina/log;
import wso2/gateway;
import wso2/throttler;

function {{funcName}}() {
    stream<gateway:GlobalThrottleStreamDTO> resultStream;
    stream<gateway:EligibilityStreamDTO> eligibilityStream;
    forever {
        from gateway:requestStream
        select gateway:requestStream.messageID, (gateway:requestStream.{{tierType}} == "{{name}}") as isEligible, gateway:requestStream.{{policyKey}} as throttleKey
        => (gateway:EligibilityStreamDTO[] counts) {
            eligibilityStream.publish(counts);
        }

        from eligibilityStream
        throttler:timeBatch([{{unitTime}}, 0])
        where eligibilityStream.isEligible == true
        select eligibilityStream.throttleKey, eligibilityStream.messageID.length() >= {{count}} as isThrottled, {{stopOnQuotaReach}} as stopOnQuota, 0 as expiryTimeStamp
        group by eligibilityStream.throttleKey
        => (gateway:GlobalThrottleStreamDTO[] counts) {
            resultStream.publish(counts);
        }

        from resultStream
        throttler:emitOnStateChange(resultStream.throttleKey, resultStream.isThrottled)
        select resultStream.throttleKey, resultStream.isThrottled, resultStream.stopOnQuota, resultStream.expiryTimeStamp
        => (gateway:GlobalThrottleStreamDTO[] counts) {
            gateway:globalThrottleStream.publish(counts);
        }
    }
}